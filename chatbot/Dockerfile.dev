FROM python:3.10.6-slim-bullseye
WORKDIR /app

# System deps for matplotlib headless
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libgl1 libglib2.0-0 libsm6 libxext6 libxrender1 libatomic1 \
    git && \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./requirements.txt
RUN pip install --no-cache-dir -r requirements.txt \
    && pip install --no-cache-dir pytest==7.4.2 pytest-asyncio==0.23.7 pytest-cov black==25.1.0 pyright==1.1.406

COPY src ./src
COPY tests ./tests
COPY pytest.ini ./pytest.ini

ENV MPLBACKEND=Agg

CMD ["pytest", "-q"]
